<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seocks.shopping.mapper.PaymentMapper">

    <insert id="createPaymentDelivery" parameterType="com.seocks.shopping.model.PaymentDelivery">
        <selectKey resultType="String" keyProperty="pay.payId" order="BEFORE">
            SELECT NVL(MAX(PAY_ID) , 0) + 1 PAY_ID FROM PAYMENT_DELIVERY
        </selectKey>
        INSERT INTO PAYMENT_DELIVERY
        (
            PAY_ID
           ,NAME
           ,POST_NUMBER
           ,ADDRESS1
           ,ADDRESS2
           ,PHONE
           ,PAY_TYPE
           ,MESSAGE
           ,USER_ID
           ,BUY_DATE
        )
        VALUES
        (
            #{pay.payId}
           ,#{pay.name}
           ,#{pay.postNumber}
           ,#{pay.address1}
           ,#{pay.address2}
           ,#{pay.phone}
           ,#{pay.payType}
           ,#{pay.message}
           ,#{pay.userId}
           ,SYSDATE
        )
    </insert>

    <insert id="createPayment" parameterType="com.seocks.shopping.model.Payment">
        INSERT INTO PAYMENT
        (
            PAY_ID
           ,PNO
           ,PSIZE
           ,QTY
           ,PRICE
        )
        VALUES
        (
            #{pay.payId}
           ,#{pay.pno}
           ,#{pay.psize}
           ,#{pay.qty}
           ,#{pay.price}
        )
    </insert>

    <select id="selectBoughtGroup" resultType="com.seocks.shopping.model.Bought">
        SELECT A.PNO
              ,A.PNAME
              ,A.PINFO
              ,A.PMAINIMG
              ,A.PSUBIMG
              ,B.PSIZE
              ,B.QTY
              ,B.PRICE
          FROM SHOPPING A
              ,( SELECT PNO
                       ,PSIZE
                       ,SUM(QTY) QTY
                       ,SUM(QTY) * MAX(PRICE) PRICE
                   FROM PAYMENT
                  WHERE PAY_ID IN ( SELECT PAY_ID FROM PAYMENT_DELIVERY WHERE USER_ID = #{userId} )
                  GROUP BY PNO , PSIZE ) B
         WHERE A.PNO = B.PNO
    </select>

    <select id="selectBought" resultType="com.seocks.shopping.model.Bought">
        SELECT A.PNO
              ,A.PSIZE
              ,A.QTY
              ,A.PRICE
              ,C.PNAME
              ,C.PINFO
              ,C.PMAINIMG
              ,C.PSUBIMG
              ,B.BUY_DATE
          FROM PAYMENT A
              ,PAYMENT_DELIVERY B
              ,SHOPPING C
         WHERE A.PAY_ID = B.PAY_ID
           AND B.USER_ID = #{userId}
           AND A.PNO = C.PNO
         ORDER BY BUY_DATE
    </select>

</mapper>